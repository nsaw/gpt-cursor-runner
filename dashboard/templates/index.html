<!-- Next-Gen Dashboard (compact, dark, glass-morphism, mobile-first) -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>***REMOVED*** RUNNER ‚Äî NextGen Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #232529;
        --pnl: #19233153;
        --brd: #a5a5d64e;
        --txt: #3e9fe4f5;
        --sub: #d3dce7;
        --sub2: #818181;
        --head1: #babad3c0;
        --head2: #c2c2ff;
        --ok: #14936693;
        --warn: #f8a3249d;
        --err: #df131379;
        --grad: linear-gradient(135deg, #153d2f 0%, #1b637b 100%);
        --glass-shadow: 0 8px 32px 0 rgba(1, 2, 16, 0.569);
        --alert-info: #2196f3;
        --alert-warning: #f8a324;
        --alert-error: #e35b6b;
        --alert-critical: #ff5353;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Ubuntu, sans-serif;
        background: var(--bg);
        color: var(--txt);
        line-height: 1.75;
      }
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        font-weight: 900;
        text-align: center;
        margin: 6px 0;
        background: var(--grad);
        -webkit-background-clip: text;
        color: transparent;
      }
      h3 {
        font-size: clamp(1rem, 3vw, 0.9rem);
        color: var(--sub);
        text-align: center;
        text-transform: lowercase;
        font-weight: 400;
        margin-bottom: 16px;
      }
      .wrap {
        max-width: 430px;
        margin: auto;
        padding: clamp(10px, 3vw, 28px);
      }
      .grid {
        display: grid;
        gap: clamp(14px, 2vw, 24px);
      }
      .card {
        background: var(--pnl);
        backdrop-filter: blur(14px);
        border: 1px solid var(--brd);
        border-radius: 14px;
        padding: 20px;
        box-shadow: var(--glass-shadow);
        transition: transform 0.25s ease;
      }
      .card:hover {
        transform: translateY(-4px);
      }
      .card h2 {
        font-size: 1.05rem;
        margin-bottom: 0.9rem;
        text-transform: uppercase;
        color: var(--head2);
        font-weight: 600;
      }
      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--brd);
        font-size: 0.83rem;
      }
      .metric:last-child {
        border: none;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        background: var(--sub);
      }
      .ok {
        background: var(--ok);
      }
      .warn {
        background: var(--warn);
      }
      .err {
        background: var(--err);
      }
      pre {
        font-family: monospace;
        font-size: 0.75rem;
        white-space: pre-wrap;
        max-height: 200px;
        overflow: auto;
        margin-top: 0.6rem;
        padding: 8px;
        background: var(--pnl);
        border: 1px solid var(--brd);
        border-radius: 10px;
      }
      button {
        all: unset;
        cursor: pointer;
        padding: 0.5rem 1rem;
        background: var(--grad);
        border-radius: 8px;
        font-weight: 600;
        color: #000;
        display: inline-block;
        margin-top: 0.8rem;
      }
      .section-title {
        margin: 24px 0 12px;
        color: var(--sub);
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        text-align: center;
      }
      ul.generic-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .generic-list li {
        padding: 6px 0;
        border-bottom: 1px solid var(--brd);
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        white-space: nowrap;
      }
      .generic-list li:last-child {
        border: none;
      }
      .list-id {
        font-family: monospace;
        color: var(--txt);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 60%;
      }
      .list-time {
        color: var(--sub);
        font-size: 0.75rem;
        flex-shrink: 0;
      }
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .status-card {
        background: var(--pnl);
        border-radius: 8px;
        padding: 10px;
        border: 1px solid var(--brd);
        text-align: center;
      }
      .telemetry-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .telemetry-card {
        background: var(--pnl);
        border-radius: 8px;
        padding: 12px;
        border: 1px solid var(--brd);
      }
      .telemetry-card h4 {
        margin: 0 0 8px 0;
        color: var(--head2);
        font-size: 0.8rem;
        text-transform: uppercase;
      }
      .telemetry-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 0.75rem;
      }
      .telemetry-value {
        font-weight: bold;
        color: var(--txt);
      }
      .telemetry-label {
        color: var(--sub);
      }
      .status-card h3 {
        margin-bottom: 8px;
        color: var(--txt);
        font-size: 0.8rem;
      }
      .status-indicator {
        font-size: 1rem;
        font-weight: bold;
        padding: 6px;
        border-radius: 4px;
        transition: all 0.3s ease;
      }
      .status-indicator.status-ok {
        background: var(--ok);
        color: #0cea4f;
      }
      .status-indicator.status-error {
        background: var(--err);
        color: #fff;
      }
      .status-indicator.status-unknown {
        background: var(--warn);
        color: #000;
      }
      .agent-section {
        background: var(--pnl);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid var(--brd);
        margin-bottom: 15px;
      }
      .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .agent-name {
        font-weight: bold;
        color: var(--ok);
        font-size: 1rem;
      }
      .agent-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .agent-status.healthy {
        background: var(--ok);
        color: #09e04a;
      }
      .agent-status.pending {
        background: var(--warn);
        color: #000;
      }
      .agent-status.stopped {
        background: var(--err);
        color: #fff;
      }
      .agent-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        margin-bottom: 10px;
      }
      .agent-metric {
        text-align: center;
        padding: 6px;
        background: var(--bg);
        border-radius: 4px;
      }
      .agent-metric-label {
        font-size: 0.7rem;
        color: var(--sub);
        margin-bottom: 2px;
      }
      .agent-metric-value {
        font-size: 1rem;
        font-weight: bold;
        color: var(--txt);
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: var(--sub);
      }
      .error-message {
        background: var(--err);
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .agent-subsection {
        margin-top: 15px;
      }
      .agent-subsection h4 {
        color: var(--head1);
        font-weight: 400;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 8px;
      }
      /* Modern Alert Styles */
      .alert-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .alert-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
        background: rgba(44, 46, 63, 0.82);
        border: 1px solid var(--brd);
        border-radius: 8px;
        box-shadow: 0 2px 10px #1c243a1a;
        padding: 9px 10px;
        font-size: 0.92em;
        position: relative;
      }
      .alert-icon {
        font-size: 1.15em;
        margin-right: 6px;
      }
      .alert-content {
        flex: 1;
      }
      .alert-title {
        font-family: monospace;
        font-size: 0.99em;
        color: var(--head2);
        font-weight: 500;
      }
      .alert-message {
        color: var(--txt);
        font-size: 0.91em;
      }
      .alert-time {
        color: var(--sub2);
        font-size: 0.78em;
        margin-top: 2px;
      }
      .alert-badge {
        border-radius: 4px;
        padding: 3px 9px;
        font-weight: 600;
        font-size: 0.81em;
        text-align: center;
        margin-left: auto;
      }
      .alert-badge.info {
        color: var(--alert-info);
        background: #243e56a1;
      }
      .alert-badge.warning {
        color: var(--alert-warning);
        background: #3b2a1c65;
      }
      .alert-badge.error {
        color: var(--alert-error);
        background: #50213265;
      }
      .alert-badge.critical {
        color: #fff;
        background: var(--alert-critical);
      }
      .alert-section-title {
        color: var(--head1);
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        margin: 16px 0 8px;
      }
      /* Responsive tweak */
      @media (max-width: 700px) {
        .wrap {
          max-width: 98vw;
          padding: 7vw 2vw;
        }
        .card {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>***REMOVED*** RUNNER</h1>
      <h3>[ dual-agent dashboard ]</h3>

      <!-- Overall health -->
      <div class="metric" style="margin-bottom: 2px">
        <span>Overall</span><span id="overallDot" class="dot sub"></span>
      </div>

      <!-- CYOPS / DEV -->
      <div class="section-title">CYOPS / DEV [ HEALTH + STATUS ]</div>
      <div class="grid" id="cyopsGrid"></div>

      <!-- MAIN / BRAUN -->
      <div class="section-title">MAIN / BRAUN [ HEALTH + STATUS ]</div>
      <div class="grid" id="mainGrid"></div>

      <!-- Shared Services -->
      <div class="section-title">***REMOVED*** | SYSTEMS | METRICS | STATUS</div>
      <div class="grid">
        <!-- Component Health -->
        <div class="card">
          <h2>‚öôÔ∏è Component Health</h2>
          <div class="status-grid">
            <div class="status-card">
              <h3>Fly.io</h3>
              <div id="health-fly" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Webhook Tunnel</h3>
              <div id="health-tunnel-webhook" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Dashboard Tunnel</h3>
              <div id="health-tunnel-dashboard" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Flask</h3>
              <div id="health-flask" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>BRAUN DAEMON</h3>
              <div id="health-braun" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Ghost Runner</h3>
              <div id="health-ghost" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Patch Executor</h3>
              <div id="health-executor" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Dashboard Uplink</h3>
              <div id="health-uplink" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Summary Watcher</h3>
              <div id="health-watcher" class="status-indicator">‚Ä¶</div>
            </div>
            <div class="status-card">
              <h3>Comprehensive Dashboard</h3>
              <div id="health-comprehensive" class="status-indicator">‚Ä¶</div>
            </div>
            <!-- Ghost 2.0 Advanced Capabilities -->
            <div class="status-card">
              <h3>ü§ñ Autonomous Decision</h3>
              <div
                id="health-autonomous-decision-daemon"
                class="status-indicator"
              >
                ‚Ä¶
              </div>
            </div>
            <div class="status-card">
              <h3>üìä Telemetry Orchestrator</h3>
              <div
                id="health-telemetry-orchestrator-daemon"
                class="status-indicator"
              >
                ‚Ä¶
              </div>
            </div>
            <div class="status-card">
              <h3>üìà Metrics Aggregator</h3>
              <div
                id="health-metrics-aggregator-daemon"
                class="status-indicator"
              >
                ‚Ä¶
              </div>
            </div>
            <div class="status-card">
              <h3>üö® Alert Engine</h3>
              <div id="health-alert-engine-daemon" class="status-indicator">
                ‚Ä¶
              </div>
            </div>
            <div class="status-card">
              <h3>üìù Enhanced Doc Daemon</h3>
              <div id="health-enhanced-doc-daemon" class="status-indicator">
                ‚Ä¶
              </div>
            </div>
          </div>
        </div>

        <!-- Unified Manager Status (Collapsible) -->
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              cursor: pointer;
            "
            onclick="toggleSection('unified-manager')"
          >
            <h2>üîß Unified Manager Status</h2>
            <span
              id="unified-manager-toggle"
              style="font-size: 1.2rem; transition: transform 0.3s ease"
              >‚ñº</span
            >
          </div>
          <div id="unified-manager-content" style="display: none">
            <div style="margin-bottom: 15px">
              <button
                onclick="updateUnifiedManager()"
                style="
                  background: var(--pnl);
                  border: 1px solid var(--brd);
                  color: var(--txt);
                  padding: 5px 10px;
                  border-radius: 4px;
                  font-size: 0.8rem;
                  margin-right: 5px;
                "
              >
                üîÑ Refresh
              </button>
              <button
                onclick="startAllServices()"
                style="
                  background: var(--ok);
                  border: 1px solid var(--brd);
                  color: #000;
                  padding: 5px 10px;
                  border-radius: 4px;
                  font-size: 0.8rem;
                  margin-right: 5px;
                "
              >
                ‚ñ∂Ô∏è Start All
              </button>
              <button
                onclick="stopAllServices()"
                style="
                  background: var(--err);
                  border: 1px solid var(--brd);
                  color: #fff;
                  padding: 5px 10px;
                  border-radius: 4px;
                  font-size: 0.8rem;
                "
              >
                ‚èπÔ∏è Stop All
              </button>
            </div>

            <!-- Service Orchestration Summary -->
            <div class="metric">
              <span>üîß Manager Status</span>
              <span id="manager-status">Loading‚Ä¶</span>
            </div>
            <div class="metric">
              <span>üìä Total Services</span>
              <span id="total-services">Loading‚Ä¶</span>
            </div>
            <div class="metric">
              <span>‚úÖ Healthy Services</span>
              <span id="healthy-services" style="color: #14936693"
                >Loading‚Ä¶</span
              >
            </div>
            <div class="metric">
              <span>‚ùå Unhealthy Services</span>
              <span id="unhealthy-services" style="color: #df131379"
                >Loading‚Ä¶</span
              >
            </div>

            <!-- Critical Services Status -->
            <div style="margin-top: 15px">
              <div class="alert-section-title">üö® Critical Services Status</div>
              <div id="critical-services-grid" class="status-grid"></div>
            </div>

            <!-- Service Actions -->
            <div style="margin-top: 15px">
              <div class="alert-section-title">‚ö° Quick Actions</div>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                  gap: 8px;
                  margin-top: 8px;
                "
              >
                <button
                  onclick="serviceAction('MAIN-backend-api', 'start')"
                  style="
                    background: var(--pnl);
                    border: 1px solid var(--brd);
                    color: var(--txt);
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.7rem;
                  "
                >
                  ‚ñ∂Ô∏è MAIN Backend
                </button>
                <button
                  onclick="serviceAction('expo-dev', 'start')"
                  style="
                    background: var(--pnl);
                    border: 1px solid var(--brd);
                    color: var(--txt);
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.7rem;
                  "
                >
                  ‚ñ∂Ô∏è Expo Dev
                </button>
                <button
                  onclick="serviceAction('expo-web', 'start')"
                  style="
                    background: var(--pnl);
                    border: 1px solid var(--brd);
                    color: var(--txt);
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.7rem;
                  "
                >
                  ‚ñ∂Ô∏è Expo Web
                </button>
                <button
                  onclick="serviceAction('ngrok-tunnel', 'start')"
                  style="
                    background: var(--pnl);
                    border: 1px solid var(--brd);
                    color: var(--txt);
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.7rem;
                  "
                >
                  ‚ñ∂Ô∏è Ngrok
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Service Logs Section (Collapsible) -->
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              cursor: pointer;
            "
            onclick="toggleSection('service-logs')"
          >
            <h2>üìã Service Logs</h2>
            <span
              id="service-logs-toggle"
              style="font-size: 1.2rem; transition: transform 0.3s ease"
              >‚ñ≤</span
            >
          </div>
          <div id="service-logs-content" style="display: block">
            <div style="margin-bottom: 15px">
              <button
                onclick="updateServiceLogs()"
                style="
                  background: var(--pnl);
                  border: 1px solid var(--brd);
                  color: var(--txt);
                  padding: 5px 10px;
                  border-radius: 4px;
                  font-size: 0.8rem;
                "
              >
                üîÑ Refresh Logs
              </button>
            </div>
            <div
              id="service-logs-container"
              style="
                max-height: 800px;
                max-width: 360px;
                overflow-y: auto;
                overflow-x: hidden;
              "
            >
              <div style="text-align: center; color: var(--sub); padding: 20px">
                Loading service logs...
              </div>
            </div>
          </div>
        </div>

        <!-- Telemetry Dashboard -->
        <div class="card">
          <h2>üìä Telemetry Dashboard</h2>
          <div style="margin-bottom: 10px">
            <button
              onclick="updateTelemetryDashboard()"
              style="
                background: var(--pnl);
                border: 1px solid var(--brd);
                color: var(--txt);
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.8rem;
              "
            >
              üîÑ Refresh Telemetry
            </button>
          </div>
          <div class="telemetry-grid" id="telemetry-dashboard">
            <!-- Telemetry cards will be populated here -->
          </div>
        </div>

        <!-- Alert Engine Dashboard (Modernized) -->
        <div class="card">
          <h2>üö® Alert Engine Dashboard</h2>
          <div style="margin-bottom: 10px">
            <button
              onclick="updateAlertDashboard()"
              style="
                background: var(--pnl);
                border: 1px solid var(--brd);
                color: var(--txt);
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.8rem;
              "
            >
              üîÑ Refresh Alerts
            </button>
          </div>
          <div class="metric">
            <span>Active Alerts</span>
            <span id="active-alerts-count">Loading‚Ä¶</span>
          </div>
          <div class="metric">
            <span>Critical Alerts</span>
            <span id="critical-alerts-count">Loading‚Ä¶</span>
          </div>
          <div class="metric">
            <span>Alert Engine Status</span>
            <span id="alert-engine-status">Loading‚Ä¶</span>
          </div>
          <div style="margin-top: 15px">
            <div class="alert-section-title">Active Alerts</div>
            <ul id="active-alerts-list" class="alert-list"></ul>
          </div>
          <div style="margin-top: 15px">
            <div class="alert-section-title">Recent Alert History</div>
            <ul id="alert-history-list" class="alert-list"></ul>
          </div>
        </div>

        <!-- System Resources -->
        <div class="card">
          <h2>SYSTEM RESOURCES [ CPU, MEMORY, DISK, UPTIME ]</h2>
          <div class="metric">
            <span>Memory Usage</span>
            <span id="memory-usage">Loading‚Ä¶</span>
          </div>
          <div class="metric">
            <span>CPU Usage</span>
            <span id="cpu-usage">Loading‚Ä¶</span>
          </div>
          <div class="metric">
            <span>Disk Usage</span>
            <span id="disk-usage">Loading‚Ä¶</span>
          </div>
          <div class="metric">
            <span>Uptime</span>
            <span id="uptime">Loading‚Ä¶</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      let data = {};
      let updateInterval;

      function concatenateFilename(filename, maxLength = 35) {
        if (!filename || filename.length <= maxLength) {
          return filename;
        }

        // Extract file extension
        const lastDotIndex = filename.lastIndexOf(".");
        if (lastDotIndex === -1) {
          // No extension, just truncate
          return `${filename.substring(0, maxLength - 3)}...`;
        }

        const name = filename.substring(0, lastDotIndex);
        const extension = filename.substring(lastDotIndex);

        // If name is already short enough, return as is
        if (name.length <= maxLength - 3) {
          return filename;
        }

        // Truncate name and add ellipsis
        const truncatedName = `${name.substring(0, maxLength - 6)}...`;
        return truncatedName + extension;
      }

      function formatTimestamp(timestamp) {
        if (!timestamp) return "Never";
        const date = new Date(timestamp);
        return date.toLocaleString();
      }

      function formatUptime(seconds) {
        if (!seconds) return "Unknown";
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
      }

      function updateOverallHealth() {
        const dot = document.getElementById("overallDot");
        if (!data.agent_status) return;

        const mainHealthy = data.agent_status.MAIN?.pending === 0;
        const cyopsHealthy = data.agent_status.CYOPS?.pending === 0;
        const allHealthy = mainHealthy && cyopsHealthy;

        dot.className = `dot ${allHealthy ? "ok" : "warn"}`;
      }

      function updateAgentGrid(agentName, agentData) {
        console.log(
          `[dashboard] Updating ${agentName} grid with data:`,
          agentData,
        );
        const grid = document.getElementById(agentName.toLowerCase() + "Grid");
        console.log(`[dashboard] Found grid element:`, grid);
        if (!grid || !agentData) {
          console.log(`[dashboard] Missing grid or data for ${agentName}`);
          return;
        }

        const statusClass = agentData.pending > 0 ? "pending" : "healthy";
        const statusText =
          agentData.pending > 0 ? `${agentData.pending} Pending` : "Healthy";

        // Get agent-specific data
        const patches = data.patch_status?.[agentName] || {};
        const summaries = patches.summaries || [];
        const executions = patches.patches || [];
        const logs = data.recent_logs || [];

        grid.innerHTML = `
        <div class="card">
          <h2>${agentName} Agent</h2>
          <div class="metric">
            <span>Status</span>
            <span class="agent-status ${statusClass}">${statusText}</span>
          </div>
          <div class="metric">
            <span>Pending</span>
            <span>${agentData.pending}</span>
          </div>
          <div class="metric">
            <span>Completed</span>
            <span>${agentData.completed}</span>
          </div>
          <div class="metric">
            <span>Summary Monitor</span>
            <span>${agentData.processes["summary-monitor"] || "Unknown"}</span>
          </div>
          <div class="metric">
            <span>Patch Executor</span>
            <span>${agentData.processes["patch-executor"] || "Unknown"}</span>
          </div>

          <!-- Patch Delivery Section -->
          <div class="agent-subsection">
            <h4>üöö Patch Delivery</h4>
            <ul class="generic-list">
              ${
                executions.length > 0
                  ? executions
                      .slice(0, 3)
                      .map((exec) => {
                        const name = exec.name || "Unknown";
                        const concatenatedName = concatenateFilename(name, 35);
                        return `<li>
                  <span class="list-id" title="${name}">${concatenatedName}</span>
                  <span class="list-time">${new Date(exec.timestamp || Date.now()).toLocaleTimeString()}</span>
                  <span class="dot ${exec.status === "completed" ? "ok" : exec.status === "failed" ? "err" : "warn"}"></span>
                </li>`;
                      })
                      .join("")
                  : `<li>${agentData.completed} patches completed</li>`
              }
            </ul>
          </div>

          <!-- Execution History Section -->
          <div class="agent-subsection">
            <h4>üèÉ Execution History</h4>
            <ul class="generic-list">
              ${
                executions.length > 0
                  ? executions
                      .slice(0, 3)
                      .map((exec) => {
                        const name = exec.name || "Unknown";
                        const concatenatedName = concatenateFilename(name, 35);
                        return `<li>
                  <span class="list-id" title="${name}">${concatenatedName}</span>
                  <span class="list-time">${new Date(exec.timestamp || Date.now()).toLocaleTimeString()}</span>
                  <span class="dot ${exec.status === "completed" ? "ok" : exec.status === "failed" ? "err" : "warn"}"></span>
                </li>`;
                      })
                      .join("")
                  : `<li>${agentData.completed} executions completed</li>`
              }
            </ul>
          </div>

          <!-- Recent Summaries Section -->
          <div class="agent-subsection">
            <h4>üì∞ Recent Summaries</h4>
            <ul class="generic-list">
              ${
                summaries
                  .slice(0, 3)
                  .map((summary) => {
                    const name = summary || "Unknown";
                    const concatenatedName = concatenateFilename(name, 35);
                    return `<li>
                  <span class="list-id" title="${name}">${concatenatedName}</span>
                  <span class="list-time">${new Date().toLocaleTimeString()}</span>
                </li>`;
                  })
                  .join("") || "<li>No recent summaries</li>"
              }
            </ul>
          </div>

          <!-- Recent Logs Section -->
          <div class="agent-subsection">
            <h4>üìù Recent Logs</h4>
            <div style="font-size:.75rem;max-height:100px;overflow-y:auto;">
              ${
                logs
                  .slice(0, 3)
                  .map((log) => {
                    return `<div style="margin:2px 0;color:var(--txt);">
                  <span style="color:var(--sub);">${new Date(log.timestamp).toLocaleTimeString()}</span>
                  <span style="color:var(--ok);">${log.level || "INFO"}</span>
                  <span>${(log.message || "No message").substring(0, 50)}...</span>
                </div>`;
                  })
                  .join("") ||
                '<div style="color:var(--sub);">No recent logs</div>'
              }
            </div>
          </div>

          <!-- Service Logs Section -->
          <div class="agent-subsection">
            <h4>üîß Service Logs</h4>
            <div style="font-size:.75rem;max-height:120px;overflow-y:auto;" id="agent-service-logs-${agentName.toLowerCase()}">
              <div style="color:var(--sub);">Loading service logs...</div>
            </div>
          </div>
        </div>
      `;
      }

      function updateComponentHealth() {
        const health = data.process_health || {};
        const daemonStatus = data.daemon_status || {};
        const processHealth = health.daemons || {};
        const telemetryComponents =
          data.telemetry?.components?.components || {};

        console.log("[health] Debug - Data structure:", {
          hasProcessHealth: !!data.process_health,
          hasDaemonStatus: !!data.daemon_status,
          hasTelemetryComponents: !!data.telemetry?.components?.components,
          processHealthKeys: Object.keys(processHealth),
          daemonStatusKeys: Object.keys(daemonStatus),
          telemetryComponentKeys: Object.keys(telemetryComponents),
        });

        // Map frontend component IDs to telemetry component keys
        const components = [
          ["fly", "Fly.io", "fly"],
          ["tunnel-webhook", "Webhook Tunnel", "webhook-tunnel"],
          ["tunnel-dashboard", "Dashboard Tunnel", "dashboard-tunnel"],
          ["flask", "Flask App", "flask"],
          ["braun", "BRAUN Daemon", "braun-daemon"],
          ["ghost", "Ghost Runner", "ghost-runner"],
          ["executor", "Patch Executor", "patch-executor"],
          ["uplink", "Dashboard Uplink", "dashboard-uplink"],
          ["watcher", "Summary Watcher", "summary-watcher"],
          [
            "comprehensive",
            "Comprehensive Dashboard",
            "comprehensive-dashboard",
          ],
          // Ghost 2.0 Advanced Capabilities
          [
            "autonomous-decision-daemon",
            "Autonomous Decision Engine",
            "autonomous-decision",
          ],
          [
            "telemetry-orchestrator-daemon",
            "Telemetry Orchestrator",
            "telemetry-orchestrator",
          ],
          [
            "metrics-aggregator-daemon",
            "Metrics Aggregator",
            "metrics-aggregator",
          ],
          ["alert-engine-daemon", "Alert Engine", "alert-engine"],
          [
            "enhanced-doc-daemon",
            "Enhanced Document Daemon",
            "enhanced-doc-daemon",
          ],
        ];

        components.forEach(([key, label, telemetryKey]) => {
          const el = document.getElementById("health-" + key);
          if (!el) {
            console.warn(`[health] Element not found: health-${key}`);
            return;
          }

          // Check telemetry components first (this is the primary source)
          let status = "unknown";
          let source = "none";

          if (telemetryComponents[telemetryKey]) {
            status = telemetryComponents[telemetryKey].status;
            source = "telemetry_components";
          }
          // Fallback to daemon_status
          else if (daemonStatus[telemetryKey]) {
            status = daemonStatus[telemetryKey];
            source = "daemon_status";
          }
          // Fallback to process_health.daemons
          else if (processHealth[telemetryKey]) {
            status =
              processHealth[telemetryKey].status || processHealth[telemetryKey];
            source = "process_health.daemons";
          }
          // Fallback to process_health
          else if (health[telemetryKey]) {
            status = health[telemetryKey].status || health[telemetryKey];
            source = "process_health";
          }
          // Fallback to agent_status processes
          else if (data.agent_status) {
            if (data.agent_status.CYOPS?.processes?.[telemetryKey]) {
              status = data.agent_status.CYOPS.processes[telemetryKey];
              source = "agent_status.CYOPS";
            } else if (data.agent_status.MAIN?.processes?.[telemetryKey]) {
              status = data.agent_status.MAIN.processes[telemetryKey];
              source = "agent_status.MAIN";
            }
          }

          // Normalize status to lowercase for comparison
          status = (status || "unknown").toLowerCase();

          const isHealthy =
            status === "healthy" ||
            status === "running" ||
            status === "active" ||
            status === "ok";
          const isError =
            status === "stopped" || status === "error" || status === "failed";

          el.className = `status-indicator ${
            isHealthy
              ? "status-ok"
              : isError
                ? "status-error"
                : "status-unknown"
          }`;
          el.textContent = isHealthy ? "‚úÖ" : isError ? "‚ùå" : "‚ö†Ô∏è";

          // Debug logging
          console.log(
            `[health] ${key} (${telemetryKey}): ${status} -> ${isHealthy ? "‚úÖ" : isError ? "‚ùå" : "‚ö†Ô∏è"} [source: ${source}]`,
          );
        });
      }

      function updateTelemetryDashboard() {
        const telemetryContainer = document.getElementById(
          "telemetry-dashboard",
        );
        if (!telemetryContainer) {
          console.error("[telemetry] Container not found");
          return;
        }
        if (!data.telemetry) {
          console.error("[telemetry] No telemetry data available");
          telemetryContainer.innerHTML = `
          <div class="telemetry-card">
            <h4>üìä Telemetry Status</h4>
            <div class="telemetry-metric">
              <span class="telemetry-label">Status</span>
              <span class="telemetry-value">No Data Available</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Last Check</span>
              <span class="telemetry-value">${new Date().toLocaleTimeString()}</span>
            </div>
          </div>
        `;
          return;
        }

        const telemetry = data.telemetry;
        console.log("[telemetry] Data received:", telemetry);

        // Create telemetry cards
        let telemetryHTML = "";

        // System Health Card
        if (telemetry.systemHealth) {
          const health = telemetry.systemHealth;
          telemetryHTML += `
          <div class="telemetry-card">
            <h4>üè• System Health</h4>
            <div class="telemetry-metric">
              <span class="telemetry-label">Overall Status</span>
              <span class="telemetry-value">${health.overall || "unknown"}</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Uptime</span>
              <span class="telemetry-value">${Math.round((health.uptime || 0) / 1000)}s</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Health Score</span>
              <span class="telemetry-value">${health.score || 0}%</span>
            </div>
          </div>
        `;
        }

        // Component Metrics Card
        if (telemetry.metrics?.metrics) {
          const metrics = telemetry.metrics.metrics;
          telemetryHTML += `
          <div class="telemetry-card">
            <h4>üîß Component Metrics</h4>
            <div class="telemetry-metric">
              <span class="telemetry-label">Total Components</span>
              <span class="telemetry-value">${metrics.totalComponents}</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Healthy</span>
              <span class="telemetry-value" style="color: #14936693;">${metrics.healthyComponents}</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Degraded</span>
              <span class="telemetry-value" style="color: #f8a3249d;">${metrics.degradedComponents}</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Unhealthy</span>
              <span class="telemetry-value" style="color: #df131379;">${metrics.unhealthyComponents + metrics.criticalComponents}</span>
            </div>
          </div>
        `;
        }

        // Recent Events Card
        if (telemetry.recentEvents && telemetry.recentEvents.length > 0) {
          telemetryHTML += `
          <div class="telemetry-card">
            <h4>üìã Recent Events</h4>
            ${telemetry.recentEvents
              .slice(0, 5)
              .map(
                (event) => `
              <div class="telemetry-metric">
                <span class="telemetry-label">${event.componentName || "System"}</span>
                <span class="telemetry-value" style="color: ${event.severity === "error" ? "#df131379" : event.severity === "warning" ? "#f8a3249d" : "#14936693"};">${event.eventType}</span>
              </div>
            `,
              )
              .join("")}
          </div>
        `;
        }

        // Component Status Card
        if (telemetry.components && telemetry.components.length > 0) {
          const healthyComps = telemetry.components.filter(
            (c) => c.health === "healthy",
          ).length;
          const totalComps = telemetry.components.length;

          telemetryHTML += `
          <div class="telemetry-card">
            <h4>üìä Component Status</h4>
            <div class="telemetry-metric">
              <span class="telemetry-label">Health Ratio</span>
              <span class="telemetry-value">${healthyComps}/${totalComps}</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Last Update</span>
              <span class="telemetry-value">${new Date().toLocaleTimeString()}</span>
            </div>
          </div>
        `;
        }

        // No Data Card
        if (!telemetryHTML) {
          telemetryHTML = `
          <div class="telemetry-card">
            <h4>üìä Telemetry Status</h4>
            <div class="telemetry-metric">
              <span class="telemetry-label">Status</span>
              <span class="telemetry-value">${telemetry.status || "No Data"}</span>
            </div>
            <div class="telemetry-metric">
              <span class="telemetry-label">Message</span>
              <span class="telemetry-value">${telemetry.message || "Telemetry not available"}</span>
            </div>
          </div>
        `;
        }

        // Add debug info
        telemetryHTML += `
        <div class="telemetry-card">
          <h4>üîç Debug Info</h4>
          <div class="telemetry-metric">
            <span class="telemetry-label">Data Available</span>
            <span class="telemetry-value">${telemetry ? "Yes" : "No"}</span>
          </div>
          <div class="telemetry-metric">
            <span class="telemetry-label">Last Update</span>
            <span class="telemetry-value">${new Date().toLocaleTimeString()}</span>
          </div>
        </div>
      `;

        telemetryContainer.innerHTML = telemetryHTML;
      }

      // --- ALERT DASHBOARD RENDERING ---
      function getSeverityClass(sev) {
        switch ((sev || "").toLowerCase()) {
          case "info":
            return "alert-badge info";
          case "warning":
            return "alert-badge warning";
          case "error":
            return "alert-badge error";
          case "critical":
            return "alert-badge critical";
          default:
            return "alert-badge";
        }
      }
      function getSeverityIcon(sev) {
        switch ((sev || "").toLowerCase()) {
          case "info":
            return "‚ÑπÔ∏è";
          case "warning":
            return "‚ö†Ô∏è";
          case "error":
            return "‚ùå";
          case "critical":
            return "üî•";
          default:
            return "‚ùî";
        }
      }
      function formatAlertTime(ts) {
        if (!ts) return "";
        let dt;
        if (typeof ts === "number" || /^\d+$/.test(ts))
          dt = new Date(Number(ts));
        else dt = new Date(ts);
        return dt.toLocaleString();
      }
      function updateAlertDashboard() {
        const alertEngineStatusEl = document.getElementById(
          "alert-engine-status",
        );
        const activeAlertsCountEl = document.getElementById(
          "active-alerts-count",
        );
        const criticalAlertsCountEl = document.getElementById(
          "critical-alerts-count",
        );
        const activeAlertsListEl =
          document.getElementById("active-alerts-list");
        const alertHistoryListEl =
          document.getElementById("alert-history-list");

        const engine = data.alert_engine_status ? data.alert_engine_status : {};
        alertEngineStatusEl.textContent = engine.status || "Unknown";
        let actives = Array.isArray(engine.active) ? engine.active : [];
        let criticals = actives.filter(
          (a) => String(a.severity).toLowerCase() === "critical",
        );
        let history = Array.isArray(engine.history) ? engine.history : [];
        activeAlertsCountEl.textContent = actives.length;
        criticalAlertsCountEl.textContent = criticals.length;
        // ACTIVE ALERTS
        if (actives.length === 0) {
          activeAlertsListEl.innerHTML = `<li style="color:var(--sub2);font-style:italic;">No active alerts</li>`;
        } else {
          activeAlertsListEl.innerHTML = actives
            .map(
              (alert) => `
          <li class="alert-item">
            <span class="alert-icon">${getSeverityIcon(alert.severity)}</span>
            <div class="alert-content">
              <div class="alert-title">${alert.title || alert.id || "Untitled Alert"}</div>
              <div class="alert-message">${alert.message || "[no message]"}</div>
              <div class="alert-time">${formatAlertTime(alert.timestamp)}</div>
            </div>
            <span class="${getSeverityClass(alert.severity)}">${String(alert.severity).charAt(0).toUpperCase() + String(alert.severity).slice(1)}</span>
          </li>
        `,
            )
            .join("");
        }
        // RECENT HISTORY
        if (history.length === 0) {
          alertHistoryListEl.innerHTML = `<li style="color:var(--sub2);font-style:italic;">No recent alert history</li>`;
        } else {
          alertHistoryListEl.innerHTML = history
            .slice(0, 10)
            .map(
              (alert) => `
          <li class="alert-item">
            <span class="alert-icon">${getSeverityIcon(alert.severity)}</span>
            <div class="alert-content">
              <div class="alert-title">${alert.title || alert.id || "Untitled Alert"}</div>
              <div class="alert-message">${alert.message || "[no message]"}</div>
              <div class="alert-time">${formatAlertTime(alert.timestamp)}</div>
            </div>
            <span class="${getSeverityClass(alert.severity)}">${String(alert.severity).charAt(0).toUpperCase() + String(alert.severity).slice(1)}</span>
          </li>
        `,
            )
            .join("");
        }
      }

      function updateSystemResources() {
        const monitor = data.unified_monitor;
        if (!monitor) return;

        document.getElementById("uptime").textContent = formatUptime(
          monitor.uptime,
        );

        // Since resources data is not available, show system status instead
        const systems = monitor.systems;
        if (systems) {
          const activeSystems = Object.keys(systems).filter(
            (key) => systems[key].status === "ACTIVE",
          ).length;
          const totalSystems = Object.keys(systems).length;

          document.getElementById("memory-usage").textContent =
            `${activeSystems}/${totalSystems} systems active`;
          document.getElementById("cpu-usage").textContent =
            `${monitor.processes?.total_ghost_processes || 0} processes`;
          document.getElementById("disk-usage").textContent =
            `${monitor.processes?.active_ports?.length || 0} ports active`;
        } else {
          document.getElementById("memory-usage").textContent =
            "System data unavailable";
          document.getElementById("cpu-usage").textContent =
            "System data unavailable";
          document.getElementById("disk-usage").textContent =
            "System data unavailable";
        }
      }

      function updateDashboard() {
        console.log("[dashboard] Updating dashboard with data:", data);
        console.log("[dashboard] Agent status:", data.agent_status);

        updateOverallHealth();

        // Merge agent status with patch status data for complete information
        const cyopsData = {
          ...(data.agent_status?.CYOPS || {}),
          ...(data.patch_status?.CYOPS || {}),
        };
        const mainData = {
          ...(data.agent_status?.MAIN || {}),
          ...(data.patch_status?.MAIN || {}),
        };

        updateAgentGrid("CYOPS", cyopsData);
        updateAgentGrid("MAIN", mainData);
        updateComponentHealth();
        updateTelemetryDashboard();
        updateAlertDashboard(); // Added this line
        updateSystemResources();
        updateUnifiedManager(); // Add unified manager update
        updateServiceLogs(); // Add service logs update
      }

      // --- UNIFIED MANAGER FUNCTIONS ---

      function toggleSection(sectionId) {
        const content = document.getElementById(sectionId + "-content");
        const toggle = document.getElementById(sectionId + "-toggle");

        if (content.style.display === "none") {
          content.style.display = "block";
          toggle.style.transform = "rotate(180deg)";
          toggle.textContent = "‚ñ≤";
        } else {
          content.style.display = "none";
          toggle.style.transform = "rotate(0deg)";
          toggle.textContent = "‚ñº";
        }
      }

      async function updateUnifiedManager() {
        try {
          const response = await fetch("/api/manager-status");
          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          const managerData = data.manager_status || {};
          const summary = data.summary || {}; // Summary is at root level, not under manager_status

          // Calculate totals from the actual data structure
          const totalServices =
            (summary.cyops_managers || 0) + (summary.main_managers || 0);
          const runningServices =
            (summary.cyops_running || 0) + (summary.main_running || 0);
          const unhealthyServices = totalServices - runningServices;

          // Update summary metrics
          document.getElementById("manager-status").textContent =
            totalServices > 0 ? "Active" : "Unknown";
          document.getElementById("total-services").textContent = totalServices;
          document.getElementById("healthy-services").textContent =
            runningServices;
          document.getElementById("unhealthy-services").textContent =
            unhealthyServices;

          // Update critical services grid
          const criticalServicesGrid = document.getElementById(
            "critical-services-grid",
          );
          if (managerData.services) {
            const criticalServices = [
              "MAIN-backend-api",
              "expo-dev",
              "expo-web",
              "ngrok-tunnel",
            ];
            let gridHTML = "";

            criticalServices.forEach((serviceName) => {
              const service = managerData.services.find(
                (s) => s.name === serviceName,
              );
              const isHealthy = service?.status === "HEALTHY";
              const statusIcon = isHealthy ? "‚úÖ" : "‚ùå";
              const statusColor = isHealthy
                ? "color: #14936693;"
                : "color: #df131379;";

              gridHTML += `
              <div class="status-card">
                <h3>${serviceName}</h3>
                <div class="status-indicator ${isHealthy ? "status-ok" : "status-error"}" style="${statusColor}">
                  ${statusIcon}
                </div>
                <div style="margin-top: 5px;">
                  <button onclick="serviceAction('${serviceName}', 'start')" style="background: var(--pnl); border: 1px solid var(--brd); color: var(--txt); padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; margin-right: 3px;">‚ñ∂Ô∏è</button>
                  <button onclick="serviceAction('${serviceName}', 'stop')" style="background: var(--pnl); border: 1px solid var(--brd); color: var(--txt); padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; margin-right: 3px;">‚èπÔ∏è</button>
                  <button onclick="serviceAction('${serviceName}', 'restart')" style="background: var(--pnl); border: 1px solid var(--brd); color: var(--txt); padding: 2px 6px; border-radius: 3px; font-size: 0.6rem;">üîÑ</button>
                </div>
              </div>
            `;
            });

            criticalServicesGrid.innerHTML = gridHTML;
          }
        } catch (error) {
          console.error("[unified-manager] Failed to update:", error);
          document.getElementById("manager-status").textContent = "Error";
        }
      }

      async function serviceAction(serviceName, action) {
        try {
          const response = await fetch("/api/service-action", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ service: serviceName, action: action }),
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          console.log(`[service-action] ${action} ${serviceName}:`, result);

          // Refresh unified manager after action
          setTimeout(updateUnifiedManager, 1000);
        } catch (error) {
          console.error(
            `[service-action] Failed to ${action} ${serviceName}:`,
            error,
          );
        }
      }

      async function startAllServices() {
        try {
          const response = await fetch("/api/service-action", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ service: "all", action: "start" }),
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          console.log("[service-action] Start all services:", result);

          // Refresh unified manager after action
          setTimeout(updateUnifiedManager, 2000);
        } catch (error) {
          console.error(
            "[service-action] Failed to start all services:",
            error,
          );
        }
      }

      async function stopAllServices() {
        try {
          const response = await fetch("/api/service-action", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ service: "all", action: "stop" }),
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const result = await response.json();
          console.log("[service-action] Stop all services:", result);

          // Refresh unified manager after action
          setTimeout(updateUnifiedManager, 2000);
        } catch (error) {
          console.error("[service-action] Failed to stop all services:", error);
        }
      }

      async function updateServiceLogs() {
        console.log("[DEBUG] updateServiceLogs() called");
        try {
          const response = await fetch("/api/service-logs");
          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const logsData = await response.json();
          console.log("[DEBUG] Service logs data received:", logsData);

          // Store logs data globally for agent cards
          window.latestServiceLogs = logsData;

          // Update agent-specific service logs
          updateAgentServiceLogs();

          const container = document.getElementById("service-logs-container");
          console.log("[DEBUG] Container found:", container);

          console.log(
            "[DEBUG] Service logs keys:",
            Object.keys(logsData.service_logs || {}),
          );
          if (
            !logsData.service_logs ||
            Object.keys(logsData.service_logs).length === 0
          ) {
            console.log("[DEBUG] No service logs found, showing fallback");
            container.innerHTML =
              '<div style="text-align: center; color: var(--sub); padding: 20px;">No service logs available</div>';
            return;
          }

          console.log("[DEBUG] Building service logs HTML");
          let logsHTML = "";
          Object.entries(logsData.service_logs).forEach(
            ([serviceName, logInfo]) => {
              const logLines = logInfo.lines || [];
              // Strip ANSI color codes and clean up the log content
              const cleanLogContent = logLines
                .map((line) => line.replace(/\u001b\[[0-9;]*m/g, "")) // Remove ANSI color codes
                .join("\n")
                .replace(/\x1b\[[0-9;]*m/g, "") // Alternative ANSI pattern
                .replace(/\[\d+\|\w+[^\]]*\]/g, "") // Remove PM2 prefixes like [32m11|patch-e |
                .trim();
              const status = logInfo.status || "unknown";
              const fileSize = logInfo.file_size || 0;

              // Only show services with actual log content
              if (logLines.length > 0 && cleanLogContent.trim() !== "") {
                logsHTML += `
              <div style="margin-bottom: 15px; background: var(--pnl); border: 1px solid var(--brd); border-radius: 8px; padding: 10px; max-width: 100%; overflow-x: hidden;">
                <h4 style="color: var(--head2); font-size: 0.8rem; margin-bottom: 8px; text-transform: uppercase; word-wrap: break-word; overflow-wrap: break-word;">
                  ${serviceName} 
                  <span style="font-size: 0.6rem; color: var(--sub);">(${status}, ${fileSize} bytes)</span>
                </h4>
                <pre style="font-size: 0.7rem; max-height: 200px; overflow-y: auto; overflow-x: auto; margin: 0; padding: 8px; background: var(--bg); border-radius: 4px; border: 1px solid var(--brd); white-space: pre-wrap; word-wrap: break-word; max-width: 100%; width: 400px; box-sizing: border-box;">${cleanLogContent}</pre>
              </div>
            `;
              }
            },
          );

          if (logsHTML === "") {
            container.innerHTML =
              '<div style="text-align: center; color: var(--sub); padding: 20px;">No active service logs found</div>';
          } else {
            container.innerHTML = logsHTML;
          }
        } catch (error) {
          console.error("[service-logs] Failed to update:", error);
          document.getElementById("service-logs-container").innerHTML =
            '<div style="text-align: center; color: var(--err); padding: 20px;">Failed to load service logs</div>';
        }
      }

      function updateAgentServiceLogs() {
        try {
          const logsData = window.latestServiceLogs;
          if (!logsData || !logsData.service_logs) {
            return;
          }

          // Update MAIN agent service logs
          const mainContainer = document.getElementById(
            "agent-service-logs-main",
          );
          if (mainContainer) {
            const mainServices = [
              "ghost-runner-MAIN",
              "MAIN-backend-api",
              "delivery-confirmation",
            ];
            let mainLogsHTML = "";

            mainServices.forEach((serviceName) => {
              const logInfo = logsData.service_logs[serviceName];
              if (logInfo && logInfo.lines && logInfo.lines.length > 0) {
                const logLines = logInfo.lines.slice(-5); // Last 5 lines
                const cleanLogContent = logLines
                  .map((line) =>
                    line
                      .replace(/\u001b\[[0-9;]*m/g, "")
                      .replace(/\x1b\[[0-9;]*m/g, ""),
                  )
                  .join("\n")
                  .trim();

                if (cleanLogContent) {
                  mainLogsHTML += `
                  <div style="margin-bottom: 8px; padding: 6px; background: var(--bg); border-radius: 4px; border: 1px solid var(--brd);">
                    <div style="color: var(--head2); font-size: 0.7rem; font-weight: bold; margin-bottom: 4px;">${serviceName}</div>
                    <pre style="font-size: 0.65rem; margin: 0; white-space: pre-wrap; word-wrap: break-word; color: var(--txt); overflow: hidden; max-height: 60px; overflow-y: auto;">${cleanLogContent}</pre>
                  </div>
                `;
                }
              }
            });

            mainContainer.innerHTML =
              mainLogsHTML ||
              '<div style="color: var(--sub); font-size: 0.7rem;">No MAIN service logs</div>';
          }

          // Update CYOPS agent service logs
          const cyopsContainer = document.getElementById(
            "agent-service-logs-cyops",
          );
          if (cyopsContainer) {
            const cyopsServices = [
              "ghost-runner-CYOPS",
              "enhanced-doc-daemon",
              "alert-engine-daemon",
            ];
            let cyopsLogsHTML = "";

            cyopsServices.forEach((serviceName) => {
              const logInfo = logsData.service_logs[serviceName];
              if (logInfo && logInfo.lines && logInfo.lines.length > 0) {
                const logLines = logInfo.lines.slice(-5); // Last 5 lines
                const cleanLogContent = logLines
                  .map((line) =>
                    line
                      .replace(/\u001b\[[0-9;]*m/g, "")
                      .replace(/\x1b\[[0-9;]*m/g, ""),
                  )
                  .join("\n")
                  .trim();

                if (cleanLogContent) {
                  cyopsLogsHTML += `
                  <div style="margin-bottom: 8px; padding: 6px; background: var(--bg); border-radius: 4px; border: 1px solid var(--brd);">
                    <div style="color: var(--head2); font-size: 0.7rem; font-weight: bold; margin-bottom: 4px;">${serviceName}</div>
                    <pre style="font-size: 0.65rem; margin: 0; white-space: pre-wrap; word-wrap: break-word; color: var(--txt); overflow: hidden; max-height: 60px; overflow-y: auto;">${cleanLogContent}</pre>
                  </div>
                `;
                }
              }
            });

            cyopsContainer.innerHTML =
              cyopsLogsHTML ||
              '<div style="color: var(--sub); font-size: 0.7rem;">No CYOPS service logs</div>';
          }
        } catch (error) {
          console.error("[agent-service-logs] Failed to update:", error);
        }
      }

      async function fetchData() {
        try {
          console.log("[dashboard] Fetching data...");

          const response = await fetch("/api/status");
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          data = await response.json();

          // Use telemetry alerts data if available
          if (data.telemetry?.alerts?.alerts) {
            data.alert_engine_status = data.telemetry.alerts.alerts;
          } else {
            data.alert_engine_status = null;
          }

          updateDashboard();
        } catch (error) {
          console.error("[dashboard] Failed to fetch data:", error);
          document.getElementById("overallDot").className = "dot err";
        }
      }

      // Initial load
      fetchData();

      // Auto-expand unified manager section on first load
      setTimeout(() => {
        toggleSection("unified-manager");
      }, 1000);

      // Poll every 30 seconds
      updateInterval = setInterval(fetchData, 30000);

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (updateInterval) {
          clearInterval(updateInterval);
        }
      });
    </script>
  </body>
</html>
