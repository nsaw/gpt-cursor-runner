const stateManager = require('../utils/stateManager');
const patchManager = require('../utils/patchManager');

module.exports = async function handleLogPhaseStatus(req, res) {
  const { user_name } = req.body;
  console.log("âš¡ï¸ /log-phase-status triggered by:", user_name);
  
  try {
    const [state, patchStats, recentPatches] = await Promise.all([
      stateManager.getState(),
      patchManager.getPatchStats(),
      patchManager.listPatches(10)
    ]);

    const phaseStatus = `
ğŸ“Š *Phase Status Report*

*Current Phase:* Phase 2 - Enhanced Automation
*Status:* ${state.paused ? 'â¸ï¸ Paused' : 'ğŸŸ¢ Active'}
*Mode:* ${state.autoMode ? 'ğŸ¤– Auto' : 'ğŸ‘¤ Manual'}

*Patch Statistics:*
â€¢ Total: ${patchStats.total}
â€¢ Approved: ${patchStats.approved} (${patchStats.successRate}%)
â€¢ Pending: ${patchStats.pending}
â€¢ Failed: ${patchStats.failed}
â€¢ Reverted: ${patchStats.reverted}

*Recent Activity:*
${recentPatches.slice(0, 5).map(patch => 
  `â€¢ ${patch.status === 'approved' ? 'âœ…' : patch.status === 'failed' ? 'âŒ' : 'â³'} ${patch.file || 'Unknown'} (${patch.status})`
).join('\n')}

*System Health:*
â€¢ Runner: ${state.lockdown ? 'ğŸ”’ Locked' : 'ğŸ”“ Unlocked'}
â€¢ Crash Fence: ${state.crashFence ? 'ğŸš§ Active' : 'âœ… Clear'}
â€¢ Auto Mode: ${state.autoMode ? 'Enabled' : 'Disabled'}

*Generated By:* ${user_name}
*Timestamp:* ${new Date().toLocaleString()}
    `.trim();

    res.send(phaseStatus);
  } catch (error) {
    console.error('Error getting phase status:', error);
    res.send(`âŒ Error getting phase status: ${error.message}`);
  }
};